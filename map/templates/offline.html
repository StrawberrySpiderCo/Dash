{% extends 'base.html' %}
{% load static %}
{% csrf_token %}
{% block title %}Device OFFLINE{% endblock %}
{% block template %}
<style>
    		.popup-container {
	display: none; 
	position: fixed;
	background: rgba(0, 0, 0, 0.6);
	
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	opacity:0;
	transition: opacity 0.5s; 
	}
	
	.popup {
	position: fixed; 
	top: 50%; 
	left: 50%; 
	transform: translate(-50%, -50%); 
	width: fit-content;
	height: fit-content;
	background-color: var(--left-menu-color);
	border: 1px solid var(--border-color);
	padding: 20px;
	box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
	transition: opacity 0.3s ease;
	border-radius: 5px;
	font-family: var(--font-family);
	z-index: 9999;
	font-size: 0.8em;
	font-weight: 700;
	text-align: center;
	white-space: nowrap;
	}

    .loader {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #3498db;
  width: 120px;
  height: 120px;
  animation: spin 2s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<h1>Device OFFLINE Please Connect to Internet</h1>
<div id="popup-container2" class="popup-container">
    <div class="popup2">
        <h2 id="popup-title">Connection to Server Failed</h2>
        <p id="popup-message">Please ensure Dashboard is connected to the internet and try again.</p>
        <div id="spinner" class="loader" style="display:none;"></div>
        <p id="success-message" style="color:green; display:none;">Device is online, redirecting to home...</p>
    </div>
</div>

<script>

var $popupContainer2 = document.getElementById('popup-container2'),
    $popup2 = $popupContainer2.querySelector('.popup2'),
    $popupTitle = document.getElementById('popup-title'),
    $popupMessage = document.getElementById('popup-message'),
    $spinner = document.getElementById('spinner'),
    $successMessage = document.getElementById('success-message');

function checkLicenseServer() {
    // Show the spinner and hide other messages
    $spinner.style.display = 'block';
    $popupMessage.style.display = 'none';
    $successMessage.style.display = 'none';

    fetch('{% url "ping_license_server" %}', {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status) {
            $spinner.style.display = 'none';
            $successMessage.style.display = 'block';
            setTimeout(function () {
                $popupContainer2.style.opacity = 0;
                setTimeout(function () {
                    $popupContainer2.style.display = 'none';
                    window.location.href = "{% url 'home' %}";
                }, 300);
            }, 2000);
        } else {
            $spinner.style.display = 'none';
            $popupMessage.style.display = 'block';
            $popupContainer2.style.display = 'block';
            setTimeout(function () {
                $popupContainer2.style.opacity = 1;
            }, 100);
        }
    })
    .catch(error => {
        $spinner.style.display = 'none';
        $popupMessage.style.display = 'block';
        $popupContainer2.style.display = 'block';
        setTimeout(function () {
            $popupContainer2.style.opacity = 1;
        }, 100);
    });
}

setInterval(checkLicenseServer, 4000);
</script>
{% endblock %}